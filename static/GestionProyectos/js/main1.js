// Generated by CoffeeScript 1.4.0
var ajax=(function($){
  var id_Usuario="";
  var e="";
  function EditarActAjax(e){
    e.preventDefault();
    alert("dentro");
          var url = '/EditarProyectoAjax/'+id_Usuario;
          var fd = $(this).serialize();
          $.ajax({
                url: url,
                data: fd,
                type: 'POST',
                success: function(data) {
                  if (data.exito) {
                      $("#resultados").html('');
                      $.ajax({
                      async:true,
                          url: 'GetDataProyectoJson/'+id_Usuario,
                          type: 'POST',
                          success: function(response) {
                            $("#"+id_Usuario).html('<td>'+response[0].fields.Proyecto+'</td><td>'+response[0].fields.Estatus+'</td><td>'+response[0].fields.Fecha+'</td><td>'+response[0].fields.Usuario+'</td><td><a href="/Actividades/"'+response[0].pk+' class="icon-eye-open" title="mostrar"/></td><td><a href="#" onclick="javascript:ajax.EditarPro('+response[0].pk+');" class="btn">Editar</a></td><td><a href="/eliminar/"'+response[0].pk+' class="btn btn-danger">Eliminar</a></td>');
                            $("#"+id_Usuario).addClass('success');
                          },
                      });
                  } else {
                    $("#resultados").html('');
                    if (data.errores.Proyecto) {
                      $('<span class="alert alert-error"><b>Proyecto </b>' + data.errores.Proyecto + '</span>').appendTo('#resultados');
                    }
                    if (data.errores.Usuario) {
                      $('<span class="alert alert-error"><b>Usuario </b>' + data.errores.Usuario + '</span>').appendTo('#resultados');
                    }
                  }
                },  
          });

  }
  function EditarProyecto(id){
      console.log(id);
      id_Usuario = id;
      $("#allformulario").attr({'title':'Editar Proyecto'});
      $("#allformulario").dialog({
                modal: true,
                width: 910,
                minWidth: 300,
                maxWidth: 300,
                height:600,
                show: "fold",
                hide: "slow",
                resizable: false,
      });
      $.ajax({
          url: 'GetDataProyectoJson/'+id,
          type: 'POST',
          success: function(data) {
            $("#id_Proyecto").val(data[0].fields.Proyecto);
            $("#id_Usuario").val(data[0].fields.Usuario);
            $("#id_Estatus").val(data[0].fields.id_Estatus)
            $("#boton").val("Terminar")
          },
          processData: false,
          contentType: false
      });
      $('#formulario').submit(EditarActAjax);
  }
  return{
    EditarPro: EditarProyecto
  }

})(jQuery);


  $(document).on('ready', inicio );
  function inicio(){
    $("#AgregarProyecto").click(function(e){
      e.preventDefault();
      $("#allformulario").attr({'title':'Agregar Proyectos'});
      $("#allformulario").dialog({
                modal: true,
                width: 800,
                minWidth: 300,
                maxWidth: 300,
                height:400,
                show: "fold",
                hide: "slow",
                resizable: false,
            });
      if (accion == 'Agregar'){
        $('#formulario').bind('submit', function(e) {
            e.preventDefault();
            var url ='/AgregarProyectoAjax/';
            var fd = new FormData($('#formulario').get(0));
            $('#exito').attr({'title':'Proyectos','href':'/ControlActividades'});
            $.ajax({
                url: url,
                data: fd,
                type: 'POST',
                   beforeSend: function(){
                         
                    },
                success: function(data) {
                  if (data.exito) {
                      $.ajax({
                            url: 'GetDataProyectoJsonLast',
                            type: 'POST',
                            success: function(response) {
                              $("#tabla tbody:last").append(
                                '<tr id='+response[0].pk+'><td>'+response[0].fields.Proyecto+
                                '</td><td>'+response[0].fields.Estatus+'</td><td>'+response[0].fields.Fecha+
                                '</td><td>'+response[0].fields.Usuario+'</td><td><a href="/Actividades/'+response[0].pk+
                                '" class="icon-eye-open" title="mostrar" ></td><td><a href="#" onclick="javascript:ajax.EditarPro('+response[0].pk+');" class="btn">Editar</a></td><td><a href="/eliminar/"'+response[0].pk+' class="btn btn-danger">Eliminar</a></td></tr>');
                              $("#tabla tr:last").addClass('success');
                              $("#formulario").get(0).reset();

                            },
                            processData: false,
                            contentType: false
                        });
                  } else {
                    $("#resultados").html('');
                    if (data.errores.Proyecto) {
                      $('<span class="alert alert-error"><b>Proyecto </b>' + data.errores.Proyecto + '</span>').appendTo('#resultados');
                    }
                    if (data.errores.Usuario) {
                      $('<span class="alert alert-error"><b>Usuario </b>' + data.errores.Usuario + '</span>').appendTo('#resultados');
                    }
                  }
                },
                processData: false,
                contentType: false
            });
        });
      }
    });
     $("#NuevaActividad").click(function(e){
      e.preventDefault();
      var id_Proyecto = location.href.substr(location.href.lastIndexOf('/')+1);
      $("#id_Proyecto").val(id_Proyecto);
      $("#id_Proyecto").hide(id_Proyecto);
      $("#allformulario").attr({'title':'Agregar Actividad'});
       var spinner = $( "#id_Points" ).spinner();
      $("#allformulario").dialog({
                modal: true,
                width: 1000,
                minWidth: 300,
                maxWidth: 300,
                height:650,
                show: "fold",
                hide: "slow",
                resizable: false,
            });
      $( "#id_Desde" ).datepicker({
        defaultDate: "+1w",
        changeMonth: true,
        numberOfMonths: 2,
        dateFormat: 'dd/mm/yy',
        onClose: function( selectedDate ) {
          $( "#id_Hasta" ).datepicker( "option", "minDate", selectedDate );
        }
      });
      $( "#id_Hasta" ).datepicker({
        defaultDate: "+1w",
        changeMonth: true,
        numberOfMonths: 3,
        dateFormat: 'dd/mm/yy',
        onClose: function( selectedDate ) {
          $( "#from" ).datepicker( "option", "maxDate", selectedDate );
        }
      });
            if (accion == 'AgregarAct') {
              $('#formulario').bind('submit', function(e) {
                  e.preventDefault();
                  var url = '/NuevaActividadAjax/';
                  var fd = $(this).serialize();
                  //var fd = new FormData($('#formulario').get(0));
                  $('#exito').attr({'title':'Proyectos','href':'/ControlActividades'});
                  
                  $.ajax({
                    url: url,
                    data: fd,
                    type: 'POST',
                    beforeSend: function(){
                         
                    },
                    success: function(data) {
                      if (data.exito) {
                        $("#resultados").html("<span class='alert alert-success'>Creado Exitosamente</span>");
                        if (accion == 'AgregarAct') {
                          $("#formulario").get(0).reset();
                          $("#exito").show();
                        };
                        if (accion == 'TerminarAct') {
                          $("#exito").show();
                        }
                      } else {
                        $("#resultados").html('');
                        if (data.errores.Actividad) {
                          $('<span class="alert alert-error"><b>Actividad </b>' + data.errores.Actividad + '</span>').appendTo('#resultados');
                        }
                        if (data.errores.Hasta) {
                          $('<span class="alert alert-error"><b>Hasta </b>' + data.errores.Hasta + '</span>').appendTo('#resultados');
                        }
                        if (data.errores.Desde) {
                          $('<span class="alert alert-error"><b>Desde </b>' + data.errores.Desde + '</span>').appendTo('#resultados');
                        }
                        if (data.errores.proyecto) {
                          $('<span class="alert alert-error"><b>proyecto </b>' + data.errores.proyecto + '</span>').appendTo('#resultados');
                        }
                      }
                    },
                    processData: false,
                    contentType: false
                  });
              });
            }
    });
    $("#AgregarAvance").click(function(e){
          e.preventDefault();
          $("#allformulario").attr({'title':'Agregar Actividad'});
          $("#allformulario").dialog({
                    modal: true,
                    width: 910,
                    minWidth: 300,
                    maxWidth: 300,
                    height:600,
                    show: "fold",
                    hide: "slow",
                    resizable: false,
                });
                if (accion == 'AgregarAvance') {
                  $('#formulario').bind('submit', function(e) {
                      e.preventDefault();
                      var url = '/AgregarAvanceAjax/';
                      var fd = new FormData($('#formulario').get(0));
                      $('#exito').attr({'title':'Proyectos','href':'/ControlActividades'});
                      $.ajax({
                        url: url,
                        data: fd,
                        type: 'POST',
                        success: function(data) {
                          if (data.exito) {
                            $("#resultados").html("<span class='alert alert-success'>Creado Exitosamente</span>");
                            if (accion == 'AgregarAct') {
                              $("#formulario").get(0).reset();
                              $("#exito").show();
                            };
                            if (accion == 'TerminarAct') {
                              $("#exito").show();
                            }
                          } else {
                            $("#resultados").html('');
                            if (data.errores.Avance) {
                              $('<span class="alert alert-error"><b>Avance </b>' + data.errores.Avance + '</span>').appendTo('#resultados');
                            }
                            if (data.errores.Points) {
                              $('<span class="alert alert-error"><b>Points </b>' + data.errores.Points + '</span>').appendTo('#resultados');
                            }
                            if (data.errores.Actividad) {
                              $('<span class="alert alert-error"><b>Actividad </b>' + data.errores.Actividad + '</span>').appendTo('#resultados');
                            }
                            
                          }
                        },
                        processData: false,
                        contentType: false
                      });
                  });
                }
        });
        


    var accion = $('#formulario').find('input[type=submit]').val();
    console.log(accion);
    var idurl = location.href.substr(location.href.lastIndexOf('/')+1);
    
    
    
    if (accion == 'TerminarAct') {
      $('#formulario').bind('submit', function(e) {
          e.preventDefault();
        var url = accion == 'AgregarAct' ? '/NuevaActividadAjax/':'/EditarActAjax/';
        var fd = new FormData($('#formulario').get(0));
        if (accion == 'TerminarAct') {
          var id_Actividad = location.href.substr(location.href.lastIndexOf('/')+1);
          fd.append('id_Actividad', id_Actividad);
        }
        $('#exito').attr({'title':'Actividades','href':'/Actividades/'+id_Actividad});
        $.ajax({
          url: url,
          data: fd,
          type: 'POST',
          success: function(data) {
            if (data.exito) {
              $("#resultados").html("<span class='alert alert-success'>Creado Exitosamente</span>");
              if (accion == 'AgregarAct') {
                $("#formulario").get(0).reset();
                $("#exito").show();
              };
              if (accion == 'TerminarAct') {
                $("#exito").show();
              }
            } else {
              $("#resultados").html('');
              if (data.errores.Actividad) {
                $('<span class="alert alert-error"><b>Actividad </b>' + data.errores.Actividad + '</span>').appendTo('#resultados');
              }
              if (data.errores.Hasta) {
                $('<span class="alert alert-error"><b>Hasta </b>' + data.errores.Hasta + '</span>').appendTo('#resultados');
              }
              if (data.errores.Desde) {
                $('<span class="alert alert-error"><b>Desde </b>' + data.errores.Desde + '</span>').appendTo('#resultados');
              }
              if (data.errores.proyecto) {
                $('<span class="alert alert-error"><b>proyecto </b>' + data.errores.proyecto + '</span>').appendTo('#resultados');
              }
            }
          },
          processData: false,
          contentType: false
        });
      });
    }
};