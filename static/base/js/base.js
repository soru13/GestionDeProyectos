// Generated by CoffeeScript 1.4.0
var ajaxStarted=(function($){
	var nombre,pswd,ip,tokenSocked,UserLoginId;
	var arrayNames = {};
	var websocket;
	var _accion="";
	
  	function started(){
  		
  	
  			$("#leido").on("click", function(){
		      $("#myModal").modal("show");
		      $.ajax({
		          async:true,
		              url: '/InBox/',
		              type: 'POST',
		              success: function(response) {
		                if (response.exito) {
		                  $("#leido").html('<img src="/static/base/img/inbox-5-24.ico"/>0 Notificaciones');
		                  console.log("exito");
		                }
		              },
		        });
		    });
		    
  		websocket = io.connect("http://10.17.1.200:8888");
		var nombre = $("#userlogin").text();
		var nombreID = $("#userlogin").attr('title');
		var token =$("input[type=hidden]").val();
		Username=nombre;
		userID=nombreID;
		$('#setNombre').fadeOut();
		//Guardamos el nombre en localStorage
		if (localStorage)
		{
			localStorage.nombreChatUsuario = Username;
		}
		websocket.emit("enviarNombre",Username,userID);


		_accion = $('#formulario').find('input[type=submit]').val();
		if (_accion=="Enviar Mensaje") {
			
			
		};
		//Cerramos sesión
		$('#btnClosSes').on("click",function(){
			localStorage.removeItem("nombreChatUsuario");
			location.reload(true);
		});	
		//Manejamos lo que el servidor nos manda
		websocket.on("mensaje",procesarUsuario);//Esta función se ejecuta cuando el servidor nos avisa que alguien se conectó
		websocket.on("newMessage",procesarMensaje);
		websocket.on("usuarioDesconectado",procesarUsuarios);
		websocket.on("errorName",repetirNombre);
	};



		//Enviamos nuestro nombre
	function sendName()
	{
		nombre = $("#name").val();
		alert(nombre);
		$('#setNombre').fadeOut();
		//Guardamos el nombre en localStorage
		if (localStorage)
		{
			localStorage.nombreChatUsuario = nombre;
		}
		websocket.emit("enviarNombre",nombre);
	};
	//Enviar el mensaje
	function sendMessage(message,img)
	{
		tokenSocked=$("#SokedID").text();
		tokenSockedlocal=$("#SokedID").attr('title');
		var msg = message;
		/*//Verificamos que no tenga scripts
		if((msg.indexOf("<") != -1))
		{
			alert("Mensaje incorrecto");
		}
		else if((msg.indexOf(">") != -1))
		{
			alert("Mensaje incorrecto");	
		}
		else if((msg.indexOf(";") != -1))
		{
			alert("Mensaje incorrecto");
		}
		else
		{
			//Limpiamos la caja del formulario		
			//$("#id_Mensaje").text("");
			//Enviamos un mensaje
			
			websocket.emit("enviarMensaje",msg);	
		}*/
		console.log(img);
		websocket.emit("enviarMensaje",msg,tokenSocked,tokenSockedlocal,img);
	};
	function procesarUsuario(mensaje)
	{
		//Esta función se ejecuta cuando el servidor nos avisa
		//que alguien se conectó
		
		$("#ingresaNombre").hide();
		//Limpiamos el div de usuarios
		$('#users').empty(); 
		//Colocamos de nuevo los usuarios
		console.log(mensaje);
			var User =$("#User").text();
			usuario = $("#userlogin").text();
			UserLoginId=$("#userlogin").attr('title');
			$("#SokedID").attr({'title':mensaje[3][UserLoginId]});//Quien lo envio
			console.log(mensaje[3][UserLoginId]);
		for (i in mensaje[3])
		{	
			if (User==i) {
				console.log(mensaje[3][i]);
		  		$("#SokedID").text(mensaje[3][i]);//al usuario que lo vas enviar por socket
			}
			
		}
		
		
		for (i in mensaje[1])
	  	{	
	  		console.log(mensaje[2][i]);
	  			$('#users').append(
		  			$('<li>').append(           
		  				$('<a>').attr({'href':'http://10.17.1.200:8000/Mensaje/'+mensaje[2][i],'id':mensaje[1][i],'title':mensaje[2][i]}).text(mensaje[1][i]))
		  		);
		  		arrayNames[i] = mensaje[1][i];

	  	}
	  	$('#users').addClass('usuarios');
	};
	//Esta función procesa los msjs
	var mentionSnd = new Audio('http://10.17.1.200:8000/static/Chat/sound/mention.wav');
	var numero = 0;
	function procesarMensaje(data,tokenSockedlocal,nickname)
	{
		mentionSnd.play();
		numero = numero + 1;
		console.log("los datos por socket: "+data);
		$("#"+nickname).text(nickname+"("+numero+")");
		$("#"+nickname).css('color','red');
		$("#titulo").text("("+numero+")"+nickname+" te mando un mensaje");
		tokenSocked=$("#SokedID").text();
		console.log("tokenSocked asd:"+tokenSockedlocal+"tokenSocked local: "+tokenSocked);
		if (tokenSockedlocal==tokenSocked) {
			$('#chatInsite').append($('<p>').append($('<article>').html(data)));			                      
			$('#chat').animate({scrollTop: $("#chatInsite").height()}, 800);
		}else{
			return false;
		}
	};
	function procesarUsuarios(data)
	{
		//Esta función se ejecuta cuando el servidor nos
		//avisa que alguien se desconectó
		$('#users').html("");
		for (i in data[0])
	  	{
	  		$('#users').append($('<p>').text(data[0][i]));
	  		arrayNames[i] = data[0][i];
	  	}
	};
	function repetirNombre()
	{
		if (parent.window.location == window.location)
    {
        window.open("","_self"); 
        window.close();
    }
    else 
        window.open("","_self"); 
        window.close();
	}
  return{
  	enviarMensaje:sendMessage,
    inicio:started
  }

})(jQuery);

$(document).on('ready', ajaxStarted.inicio );
